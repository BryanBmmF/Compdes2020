USE BD_COMPDES_4_V3;
-- carga de actividades
INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Inscripcion Compdes 2020','Inscripcion','Salon Mayor','2020-06-05 14:30:00','100','Inscripcion Compdes','Presencial','3000');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller FLEX','Taller','Salon 2','2020-06-05 15:30:00','75','Taller de FLEX','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Arduino','Taller','Salon 3','2020-06-05 15:30:00','75','Taller de Arduino','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Php','Taller','Salon 4','2020-06-05 15:30:00','75','Taller de Php','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Laravel','Taller','Salon 5','2020-06-05 15:30:00','75','Taller de Laravel','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller TypeScript','Taller','Salon 1','2020-06-05 17:30:00','75','Taller de TypeScript','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller JavaScript','Taller','Salon 2','2020-06-05 17:30:00','75','Taller de JavaScript','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Blade','Taller','Salon 3','2020-06-05 17:30:00','75','Taller de Blade','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Spring','Taller','Salon 4','2020-06-05 17:30:00','75','Taller de Spring','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Mysql','Taller','Salon 5','2020-06-05 17:30:00','75','Taller de Mysql','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller C','Taller','Salon 1','2020-06-06 15:30:00','75','Taller de C','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller C++','Taller','Salon 2','2020-06-06 15:30:00','75','Taller de C++','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller C#','Taller','Salon 3','2020-06-06 15:30:00','75','Taller de C#','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Java','Taller','Salon 4','2020-06-06 15:30:00','75','Taller de Java','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Ruby','Taller','Salon 5','2020-06-06 15:30:00','75','Taller de Ruby','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller MongoDB','Taller','Salon 1','2020-06-06 17:30:00','75','Taller de MongoDB','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Casandra','Taller','Salon 2','2020-06-06 17:30:00','75','Taller de Casandra','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Redis','Taller','Salon 3','2020-06-06 17:30:00','75','Taller de Redis','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Oracle','Taller','Salon 4','2020-06-06 17:30:00','75','Taller de Oracle','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Microsoft Server','Taller','Salon 5','2020-06-06 17:30:00','75','Taller de Microsoft Server','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Linux','Taller','Salon 1','2020-06-07 15:30:00','75','Taller de Linux','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Windows','Taller','Salon 2','2020-06-07 15:30:00','75','Taller de Windows','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller GlusterFS','Taller','Salon 3','2020-06-07 15:30:00','75','Taller de GlusterFS','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Athziri','Taller','Salon 4','2020-06-07 15:30:00','75','Taller de Athziri','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Koky','Taller','Salon 5','2020-06-07 15:30:00','75','Taller de Koky','Presencial','50');

INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Redes','Taller','Salon 1','2020-06-07 17:30:00','75','Taller de Redes','Presencial','50');


-- creacion de triggers funciones y procedimientos almacenados
-- Ahora evalua que el No.pago o pin exista y que este verificado y ademas retorna el cui para ser insertar en reg_pago

DELIMITER $$
CREATE FUNCTION verificar_pago (numero_pago VARCHAR(25)) RETURNS VARCHAR(15)

BEGIN
	-- DECLARE result BOOLEAN;
    DECLARE consulta INTEGER;
	DECLARE consulta_2 INTEGER;
    
    -- consulta a la bd
    SET consulta =(SELECT COUNT(*) FROM PARTICIPANTE WHERE No_Pago = numero_pago);
	SET consulta_2 =(SELECT COUNT(*) FROM PARTICIPANTE WHERE Pin_Pago = numero_pago);
    
    IF (consulta = 0) AND (consulta_2 = 0) THEN
		-- si no existe desplegamos el error
        SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = ' El No.Pago o Pin que ingresaste no existe, porfavor verificalo. ';
		RETURN NULL;
	ELSE 
		-- si existe verificamos que haya sido revisado
		SET consulta =(SELECT Pago_Revisado FROM PARTICIPANTE WHERE No_Pago = numero_pago);
		SET consulta_2 =(SELECT Pago_Revisado FROM PARTICIPANTE WHERE Pin_Pago = numero_pago);
        IF consulta = 1 THEN
			RETURN (SELECT CUI_Pasaporte FROM PARTICIPANTE WHERE No_Pago=numero_pago);
        ELSEIF  consulta_2 =1 THEN
			RETURN (SELECT CUI_Pasaporte FROM PARTICIPANTE WHERE Pin_Pago=numero_pago);
		ELSE
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = ' Tu No.Pago no esta revisado ahun, forfavor intenta mas tarde. ';
			RETURN NULL;
        END IF;
		
    END IF;		
END 
$$ DELIMITER ;

-- mejora del trigger ahora quitamos la validacion de pago revisado porque se hara antes para recuperar el cui
DELIMITER $$
CREATE TRIGGER TG_Insert_Pago
BEFORE INSERT ON REGISTRO_PAGO 
FOR EACH ROW
	BEGIN
        DECLARE total INTEGER;
			-- 1. si esta verificacdo y existe revisar que no este registrado en los pagos de taller 
				-- (aunque en realidad no se pagan, van incluido en la inscripcion para los primeros 200)
			IF (SELECT COUNT(*) FROM REGISTRO_PAGO WHERE P_CUI_Pasaporte=new.P_CUI_Pasaporte) = 0	THEN		
			-- 2. si no esta registrado en los pagos evaluar el cupo disponible del taller y que haya espacio
				-- (hacer un update al cupo del taller despues de validar esto)
					IF (SELECT Cupo_Limite FROM ACTIVIDAD WHERE ID_Actividad=new.A_ID_Actividad) > 0 THEN
							-- 3. se hara el insert y se hara el update al cupo del taller
							SET total =(SELECT Cupo_Limite FROM ACTIVIDAD WHERE ID_Actividad=new.A_ID_Actividad);
							SET total = total -1;
							UPDATE ACTIVIDAD SET Cupo_Limite = total WHERE  ID_Actividad=new.A_ID_Actividad;
					ELSE
					 SIGNAL SQLSTATE '45000'
					 SET MESSAGE_TEXT = ' El cupo del taller que intentas asignarte llego al limite, porfavor elige otro. ';
					END IF;
			ELSE
			  SIGNAL SQLSTATE '45000'
			  SET MESSAGE_TEXT = ' Ya te encuentras asignado a un taller, no puedes asignarte a otro. ';
			END IF;
	END
$$
DELIMITER ;


-- Creacion de procedimiento almacenado para regitrar una actividad
DELIMITER $$ 
CREATE PROCEDURE crearActividad (IN nombre VARCHAR(50),IN tipo VARCHAR(20),IN lugar VARCHAR(50),IN fecha VARCHAR(20),
				IN precio FLOAT, IN descripcion VARCHAR(200), IN modalidad VARCHAR(15), IN cupo INT)
BEGIN 
	
    INSERT INTO 
    ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite)
	VALUES
	(nombre,tipo,lugar,fecha,precio,descripcion,modalidad,cupo);
 
END$$ 
DELIMITER ;

 -- Creacion de procedimiento almacenado para regitrar un participante
DELIMITER $$ 
CREATE PROCEDURE crearParticipante (IN cui VARCHAR(15),IN no_pago VARCHAR(25),IN nombre VARCHAR(50),IN pais VARCHAR(20),
				IN uni VARCHAR(20),IN talla VARCHAR(5), IN fecha VARCHAR(20),IN correo VARCHAR(50), IN tel VARCHAR(12),
                IN coment VARCHAR(200), IN pago_rev INT, IN part_reg INT, IN pin VARCHAR(10))
BEGIN 
	
    INSERT INTO 
    PARTICIPANTE(CUI_Pasaporte,No_Pago,Nombre,Pais,Centro_Educativo,Talla_Playera,Fecha_Registro,
						Correo,No_Telefono, Expectativas,Pago_Revisado,Participante_Registrado,Pin_Pago)
	VALUES
	(cui,no_pago,nombre,pais,uni,talla,fecha,correo,tel,coment,pago_rev,part_reg,pin);
 
END$$ 
DELIMITER ;

/*insersion comun*/
-- INSERT INTO PARTICIPANTE(CUI_Pasaporte,No_Pago,Nombre,Pais,Centro_Educativo,Talla_Playera,Fecha_Registro,Correo,No_Telefono, Expectativas,Pago_Revisado,Participante_Registrado,Pin_Pago)
-- VALUES('1','1','p1','Guatemala','USAC','M','2020-06-04 14:30:00','p1@gt.com','1','Interesante','1','1','a1');

/*utilizando procedimiento almacenado para insertar participantes*/
CALL crearParticipante('1','1','p1','Guatemala','USAC','M','2020-06-04 14:30:00','p1@gt.com','1','Interesante','1','1','a1');
CALL crearParticipante('2','2','p2','Guatemala','USAC','M','2020-06-04 14:30:00','p2@gt.com','2','Interesante','1','1','a2');
CALL crearParticipante('3','3','p3','Guatemala','USAC','M','2020-06-04 14:30:00','p3@gt.com','3','Interesante','1','1','a3');
CALL crearParticipante('4','4','p4','Guatemala','USAC','M','2020-06-04 14:30:00','p4@gt.com','4','Interesante','1','1','a4');
CALL crearParticipante('5','5','p5','Guatemala','USAC','M','2020-06-04 14:30:00','p5@gt.com','5','Interesante','1','1','a5');
CALL crearParticipante('6','6','p6','Guatemala','USAC','M','2020-06-04 14:30:00','p6@gt.com','6','Interesante','1','1','a6');
CALL crearParticipante('7','7','p7','Guatemala','USAC','M','2020-06-04 14:30:00','p7@gt.com','7','Interesante','1','1','a7');
CALL crearParticipante('8','8','p8','Guatemala','USAC','M','2020-06-04 14:30:00','p8@gt.com','8','Interesante','1','1','a8');
CALL crearParticipante('9','9','p9','Guatemala','USAC','M','2020-06-04 14:30:00','p9@gt.com','9','Interesante','1','1','a9');
CALL crearParticipante('10','10','p10','Guatemala','USAC','M','2020-06-04 14:30:00','p10@gt.com','10','Interesante','1','1','b1');
CALL crearParticipante('11','11','p11','Guatemala','USAC','M','2020-06-04 14:30:00','p11@gt.com','11','Interesante','1','1','b2');
CALL crearParticipante('12','12','p12','Guatemala','USAC','M','2020-06-04 14:30:00','p12@gt.com','12','Interesante','1','1','b3');
CALL crearParticipante('13','13','p13','Guatemala','USAC','M','2020-06-04 14:30:00','p13@gt.com','13','Interesante','1','1','b4');
CALL crearParticipante('14','14','p14','Guatemala','USAC','M','2020-06-04 14:30:00','p14@gt.com','14','Interesante','1','1','b5');
CALL crearParticipante('15','15','p15','Guatemala','USAC','M','2020-06-04 14:30:00','p15@gt.com','15','Interesante','1','1','b6');
CALL crearParticipante('16','16','p16','Guatemala','USAC','M','2020-06-04 14:30:00','p16@gt.com','16','Interesante','1','1','b7');
CALL crearParticipante('17','17','p17','Guatemala','USAC','M','2020-06-04 14:30:00','p17@gt.com','17','Interesante','1','1','b8');
CALL crearParticipante('218','18','p18','Guatemala','USAC','M','2020-06-04 14:30:00','p18@gt.com','18','Interesante','0','0','b9');

-- agregando taller de prueba
INSERT INTO ACTIVIDAD(Nombre,Tipo_Actividad,Lugar,Fecha_Realizacion,Precio,Descripcion,Modalidad,Cupo_Limite) VALUES
('Taller Prueba','Taller','Salon 1','2020-06-07 17:30:00','1','Taller de Prueba','Presencial','10');


-- prubas de registro de pago en taller de prueba 27 con limite de 10 de los participantes con pago verificado

 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('1','1','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('2','2','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('3','3','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('4','4','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('5','5','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('6','6','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('7','7','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('8','8','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('9','9','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');
 INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
 VALUES('10','10','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');

-- se insertan los 10 del cupo limite, las consultas siguientes tiran error
-- pruebas de verificacion todas estas lazan el error asociado en cada funcion

-- No. de pago no existente
-- INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
-- VALUES('56','16','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');

-- Pago no revisado
-- INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
--  VALUES('16','16','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');

-- Ya se encuentra asignado a un taller
-- INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
-- VALUES('3','3','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');

-- cupo lleno del taller
-- INSERT INTO REGISTRO_PAGO(ID_Pago,P_CUI_Pasaporte,A_ID_Actividad,Lugar,Fecha_Pago,Monto,Concepto_Pago,Tipo_Rol)
-- VALUES('17','17','27','Quetzaltenango','2020-06-04 14:35:06','1','Taller','Participante');



--  drop trigger TG_Insert_Pago;
-- drop function verificar_pago;

 

/*prueba de procedimiento almacenado crear actividad*/
CALL crearActividad('Taller Prueba_2','Taller','Salon 2','2020-06-07 17:30:00','1','Taller de Prueba','Presencial','10');

/*query con formato de fecha devuelto*/
SELECT ID_Actividad,Nombre,Tipo_Actividad,Lugar, DATE_FORMAT(Fecha_Realizacion, '%d/%m/%Y  %H:%i \hrs. '),
					Precio,Descripcion,Modalidad,Cupo_Limite FROM ACTIVIDAD WHERE Tipo_Actividad='Taller';

/* 	ueda pendiente el alter table de la tabla participante para adaptarla
	a las reglas del negocio del compdes por el momento se migrara de una
	vez con los nuevos cambios del esquema para una version 3 del esquema
	para mayor facilidad
 */


/*nuevo script bd v3*/


/*Nueva Tabla User*/

 CREATE TABLE USUARIO (
  N_User VARCHAR(50) NOT NULL,
  Pass VARCHAR(60) NOT NULL,
  
  CONSTRAINT PK_USUARIO PRIMARY KEY(N_User)
  );










